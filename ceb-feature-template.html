<!DOCTYPE html>

<html>
<head>
  <title>ceb-feature-template.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>



  <div id="container">
    <div id="background"></div>

    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              <a class="source" href="index.html">
                index
              </a>
            
              <a class="source" href="changelogs.html">
                changelogs
              </a>
            
              <a class="source" href="doc.1.usage.html">
                doc - usage
              </a>
            
              <a class="source" href="doc.2.inheritance.html">
                doc - inheritance
              </a>
            
              <a class="source" href="doc.3.properties.html">
                doc - properties
              </a>
            
              <a class="source" href="doc.4.interceptors.html">
                doc - interceptors
              </a>
            
              <a class="source" href="doc.5.methods.html">
                doc - methods
              </a>
            
              <a class="source" href="doc.6.wrappers.html">
                doc - wrappers
              </a>
            
              <a class="source" href="doc.7.listeners.html">
                doc - listeners
              </a>
            
              <a class="source" href="doc.8.features.html">
                doc - features
              </a>
            
              <a class="source" href="ceb-feature-template.html">
                source - ceb-feature-template.js
              </a>
            
              <a class="source" href="ceb.html">
                source - ceb.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="ceb-feature-template-js">ceb-feature-template.js</h1>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Works on ever-green browsers and IE9/IE10.
However the template feature doesn’t work with <a href="https://github.com/WebReflection/document-register-element">document-register-element</a> on IE9/IE10.</p>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2 id="light-dom">Light DOM</h2>
<p>The template can contains a node having the attribute <code>ceb-content</code>.
The marked node is intend to host the light DOM of the current element at the end of the templating process.</p>
<p>If the template doesn’t contain this node, the light DOM will be lost.</p>
<h2 id="dom-nodes-references">DOM nodes references</h2>
<p>The template can contains nodes having the attribute <code>ceb-ref</code>.
The marked nodes will be available at the end of the templating process from the feature function (<code>feature(el)</code>).</p>
<p>That means, if a node has the attribute <code>ceb-ref=&quot;header&quot;</code>.
It will be available via <code>feature(el).header</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(g, factory)</span> </span>{
<span class="hljs-pi">    'use strict'</span>;
 
    <span class="hljs-comment">/* istanbul ignore next */</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> exports === <span class="hljs-string">'object'</span>) {
        <span class="hljs-built_in">module</span>.exports = factory();
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> define === <span class="hljs-string">'function'</span> &amp;&amp; define.amd) {
        define(<span class="hljs-string">'ceb-feature-template'</span>, [], factory);
    } <span class="hljs-keyword">else</span> {
        g.cebFeatureTemplate = factory();
    }

}(<span class="hljs-keyword">this</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
<span class="hljs-pi">    'use strict'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h2 id="feature-function">feature function</h2>

            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>The template feature’s function returns the nodes’ reference of the template.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">feature</span><span class="hljs-params">(el)</span> </span>{
        <span class="hljs-keyword">if</span> (!el.__cebTemplateScope) {
            el.__cebTemplateScope = {};
        }
        <span class="hljs-keyword">return</span> el.__cebTemplateScope;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h2 id="templating-stuff">Templating stuff</h2>

            </div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>The counter is used to generate unique DOM’s id.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> counter = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Regex to detect the <em>ceb-ref</em> attributes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> nodesRegEx = <span class="hljs-regexp">/ceb\-ref=\W*(\w*)/igm</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Regex to detect the <em>ceb-content</em> attribute</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> contentRegEx = <span class="hljs-regexp">/ceb\-content/im</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Find recursively the content’s node of the current element.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">findContentNode</span><span class="hljs-params">(el)</span> </span>{
        <span class="hljs-keyword">var</span> oldCebContentId = el.getAttribute(<span class="hljs-string">'ceb-old-content-id'</span>);
        <span class="hljs-keyword">if</span> (oldCebContentId) {
            <span class="hljs-keyword">return</span> findContentNode(el.querySelector(<span class="hljs-string">'['</span> + oldCebContentId + <span class="hljs-string">']'</span>));
        }
        <span class="hljs-keyword">return</span> el;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Apply a template to an element.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">apply</span><span class="hljs-params">(tpl, el, isHandleLightDOM, isNodeReferences)</span> </span>{
        <span class="hljs-keyword">var</span> lightChildren = [],
            refrencedNodes = [],
            template = tpl;

        <span class="hljs-keyword">if</span> (isNodeReferences) {</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Update the template to detect the DOM nodes references.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> result;
            <span class="hljs-keyword">while</span> ((result = nodesRegEx.exec(template)) !== <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">var</span> property = result[<span class="hljs-number">1</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>build an id of the reference</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">var</span> newAtt = <span class="hljs-string">'ceb-'</span> + (counter++) + <span class="hljs-string">'-ref'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>replace the original attribute name by the idenitifer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                template = template.replace(<span class="hljs-string">' ceb-ref'</span>, <span class="hljs-string">' '</span> + newAtt);</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>push the entry</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                refrencedNodes.push({
                    attribute: newAtt,
                    property: property
                });
            }
        }

        <span class="hljs-keyword">if</span> (isHandleLightDOM) {</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Get the current content node having the light DOM nodes,
When the node is freshly created, the content node is the element.
When the node has been created by clonning, the content node is not anymore the element,
but a sub content node linked to one of its descents.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            <span class="hljs-keyword">var</span> oldContentNode = findContentNode(el);</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Remove the light DOM to keep it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">while</span> (oldContentNode.childNodes.length &gt; <span class="hljs-number">0</span>) {
                lightChildren.push(oldContentNode.removeChild(oldContentNode.childNodes[<span class="hljs-number">0</span>]));
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>lightChildren = Array.prototype.slice.call(oldContentNode.childNodes);</p>

            </div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Generate the new content’s id value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> newCebContentId = <span class="hljs-string">'ceb-'</span> + (counter++) + <span class="hljs-string">'-content'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Replace the original attribute name by the id.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            template = template.replace(<span class="hljs-string">' ceb-content'</span>, <span class="hljs-string">' '</span> + newCebContentId);</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Keep a value of the content’s id value if the node is cloned.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            el.setAttribute(<span class="hljs-string">'ceb-old-content-id'</span>, newCebContentId);
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Transform the template string into an alive DOM nodes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        el.innerHTML = template;

        <span class="hljs-keyword">if</span> (isHandleLightDOM) {</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Get the content node to add him the in pending light DOM.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> newContentNode = findContentNode(el);
            lightChildren.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(child)</span> </span>{
                newContentNode.appendChild(child);</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>newContentNode.appendChild(child);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            });
        }

        <span class="hljs-keyword">if</span> (isNodeReferences) {</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Get the reference nodes and attach them to the element templating scope.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            refrencedNodes.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(entry)</span> </span>{
                feature(el)[entry.property] = el.querySelector(<span class="hljs-string">'['</span> + entry.attribute + <span class="hljs-string">']'</span>);
            });
        }

    }</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <h2 id="setup-function">Setup function</h2>

            </div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>The templeting process is done before the call of the <code>createdCallback</code> method defined in the structure.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setup</span><span class="hljs-params">(struct, builder, options)</span> </span>{
        <span class="hljs-keyword">var</span> tpl = options.template || <span class="hljs-string">''</span>;
        <span class="hljs-keyword">var</span> isHandleLightDOM = tpl.search(contentRegEx) !== -<span class="hljs-number">1</span>;
        <span class="hljs-keyword">var</span> isNodeReferences = tpl.search(nodesRegEx) !== -<span class="hljs-number">1</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Register a wrapper to the createdCallback callback in order to
apply the template before the original call.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        builder.wrap(<span class="hljs-string">'createdCallback'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(next, el)</span> </span>{
            apply(tpl, el, isHandleLightDOM, isNodeReferences);
            next(<span class="hljs-built_in">arguments</span>);
        });
    }
    feature.setup = setup;

    <span class="hljs-keyword">return</span> feature;
}));</pre></div></div>
            
        </li>
        
    </ul>
  </div>
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-20179310-4', '/custom-elements-builder');
  ga('send', 'pageview');
</script>
</body>
</html>
